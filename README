CONTENTS OF THIS FILE
---------------------

 * Introduction
 * Requirements
 * Files
 * Setup
 * Performing the Migration
 * More Information

INTRODUCTION
------------

Current Maintainer: Shaun Haber <shaun.haber@wmg.com>

This directory contains necessary script files to export content from a Drupal 5
database and import it into a Drupal 6 site. The migration phase is generally
broken into 3 separate steps: initializing, importing, and processing.

The initialization phase should only happen once, but the importing and
processing phases may be run multiple times. It is advisable to do a preliminary
run during site development to test for integration bugs, and to do a final
migration in the moments before a site relaunch.

REQUIREMENTS
------------

 * This script requires Drush. Drush is installed on our development and
   production servers. Our development server is wbrlabs.com. Our production
   server is mgmt1.p.wbrdc.com. To learn more about Drush, visit
   http://drupal.org/project/drush

 * Before the preliminary migration, a snapshot of the production site database
   needs to be setup on the dev server with the same db access credentials as
   the dev site.

 * Before the site launch, the production site must be put in a frozen state or
   be taken offline. At this time, a snapshot of the production database should
   be setup on the dev server with the same db access credentials as the dev
   site.

FILES
-----

An overview of the files contained in this directory:

  * config.ini - The configuration file in ini format.

  * config.inc - Code to parse the configuration file.

  * import.drush.php - The main script, invoked using the drush script command

  * process-example.inc - A example processing script to give an idea of the
    processing phase.

  * process.inc - The placeholder processing script where you edit and
    accumulate the post-import actions.

  * README - This file.

SETUP
-----

1. PROVISION THE NEW DEV SITE

   Setting up the new dev site should be the first thing that happens.
   Currently, this is done via a shell script on wbrlabs:

	   /home/wbrlabs/drupal6x/sites/mknew.sh <site-moniker>
	
	 This script will take care of most things including creating a project
   directory in Subversion, creating the dev database, and adding symbolic links
   to the dev environment.

   To finish the installation, visit:
   http://<site-moniker>.wbrdev.com/install.php.

2. COPY THE SCRIPT FILES TO A SPECIFIED LOCATION

   Do not edit the versioned files directly, unless you plan to permanently
   change the migration script in the repository. Copy or svn export these files
   to a new location.  A good candidate is the site project directory:

	   svn export http://svn.warnerreprise.com/projects/contentmig \
	   path/to/sites/site/contentmig
	
3. SETUP SNAPSHOT OF PRODUCTION SITE DATABASE
	
   Create a new database on the dev server. Perform a mysqldump of the
   production site and import it into the new dev database. If this is the final
   migration, be sure to put the production site in a frozen site or maintenance
   mode beforehand. Example below:

		 # On production server
		 mysqldump prod_database | gzip > prod_database.sql.gz
		 scp prod_database.sql.gz wbrlabs@wbrlabs.com: # scp file to dev server
		 rm prod_database.sql.gz # Clean up
		
		 # On dev server
		 mysqladmin create prod_database
		 gunzip prod_database.sql.gz
		 mysql prod_database < prod_database.sql
		 rm prod_database.sql # Clean up

4. EDIT CONFIG FILE WITH AUTO-INCREMENT VALUES

   Examine the production database snapshot and determine the auto-increment
   values for each table listed in the config.ini file. Consider the current
   site's age, acceleration of produced content, and the estimated date of
   launch of the new site in order to gauge appropriate values.

   Don't be afraid to add plenty of padding. The whole purpose of this is to
   prevent from encountering conflicts on sequenced IDs (they are a huge huge
   pain). You only get one chance to get this right, so be conservative and bump
   the number as high as you see fit.

   Additionally, enter the database name of the production snapshot DB. The
   script assumes it can use the dev site's DB credentials to access this DB, so
   be sure those are set on the dev server.

5. INITIALIZE THE DEV SITE

   Initialize the dev site by running drush.

     drush -l <site-moniker>.wbrdev.com script import.drush.php init

   This should be done soon after provisioning the site and before any content
   is input into the site.  This step should only be performed once.

PERFORMING THE MIGRATION
------------------------

After following the steps in the setup phase, you will be ready to perform a
migration. The basic procedure for performing a migration goes:

1. COPY THE PRODUCTION DATABASE TO THE DEV SERVER

   This is the same as STEP 3 in the setup phase.

2. RUN THE IMPORT COMMAND FROM THE DRUSH SCRIPT

   The import command inserts or replaces data for the most common Drupal
   tables. The corresponding function is __import().

     drush -l <site-moniker>.wbrdev.com script import.drush.php import

3. RUN ALL PROCESSING COMMANDS FROM THE DRUSH SCRIPT

   There will always be additional actions to perform on the imported content. A
   typical example is to append underscores to all user email addresses has a
   clever way to prevent rogue emails being sent from the dev server.

		 drush -l <site-moniker>.wbrdev.com script import.drush.php process
		 drush -l <site-moniker>.wbrdev.com script import.drush.php process_1
		 ...
		 drush -l <site-moniker>.wbrdev.com script import.drush.php process_N
		
   In the above example, there are multiple process functions. There is no
   naming convention for these functions, so it's up to you how to name them.
   See the process-example.inc file for a real example.

4. CAPTURE ALL NEW ACTIONS PERFORMED ON THE IMPORTED DATA AS CODE

   It is absolutely essential to capture any changes as code and encapsulate
   them in a function. The idea here to make everything repeatable so you can
   easily replay the changes when you perform another migration. Failure to do
   so means any changes will be lost when it comes time to do the final sync.
   
   You will gradually add code to the process.inc file as needed. You can choose
   to put all code in the single __process() function, or you may break it up
   into smaller meaningful functions. You'll need to run the drush script for
   each function you add. Function names should begin with 2 underscores. See
   the process-example.inc file.

	
MORE INFORMATION
----------------

Documentation is available at https://docs.01detail.com/node/2026